name: SafeC Static Analysis Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  analyze:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Checkout Juliet Test Suite
      run: |
        if [ ! -d "juliet-test-suite-c" ]; then
          git clone https://github.com/arichardson/juliet-test-suite-c.git
        fi
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake git
    
    - name: Build SafeC
      run: |
        mkdir -p build
        cd build
        cmake ..
        make -j$(nproc)
    
    - name: Run SafeC Analysis on Juliet Test Suite
      run: |
        ./build/safec -d --html JulietPipelineReport.html ./juliet-test-suite-c/testcases 2>&1 | tee analysis.log
        # Exit codes: 0=no issues, 1=issues found, 2=critical issues found
        # All are considered successful analysis
        exit_code=$?
        if [ $exit_code -eq 0 ] || [ $exit_code -eq 1 ] || [ $exit_code -eq 2 ]; then
          exit 0
        fi
        exit $exit_code

    - name: Compress reports for storage
      run: |
        # Compress the large HTML report
        gzip -9 JulietPipelineReport.html -c > JulietPipelineReport.html.gz
        gzip -9 analysis.log -c > analysis.log.gz
        
        # Get file sizes
        echo "=== File Sizes ==="
        du -h JulietPipelineReport.html JulietPipelineReport.html.gz analysis.log analysis.log.gz

    - name: Upload analysis log (always)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: safec-analysis-log-${{ github.run_id }}
        path: |
          analysis.log.gz
          JulietPipelineReport.html.gz
        retention-days: 30

    - name: Show tail of analysis log
      if: always()
      run: |
        if [ -f analysis.log ]; then
          echo "---- Last 200 lines of analysis.log ----";
          tail -n 200 analysis.log || true;
        else
          echo "No analysis.log found";
        fi
    
    - name: Upload HTML Report as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: safec-analysis-report
        path: JulietPipelineReport.html
        retention-days: 30
    
    - name: Create GitHub Pages index
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        mkdir -p gh-pages
        cat > gh-pages/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
          <title>SafeC Analysis Reports</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
            h1 { color: #333; }
            .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
            .report-link { margin: 10px 0; }
            .report-link a { color: #0366d6; text-decoration: none; font-size: 18px; }
            .report-link a:hover { text-decoration: underline; }
            .timestamp { color: #666; font-size: 14px; }
            .latest { background: #fff3cd; padding: 10px; border-radius: 4px; margin-bottom: 20px; }
          </style>
        </head>
        <body>
          <div class="container">
            <h1>üìä SafeC Analysis Reports</h1>
            <p>Latest vulnerability analysis reports from the SafeC static analyzer on the Juliet test suite.</p>
            
            <div class="latest">
              <strong>üìç Latest Report Summary:</strong>
              <div class="report-link">
                <a href="latest/report-summary.txt" target="_blank">üìÑ View Latest Summary</a>
                <div class="timestamp">Generated: ${{ github.event.head_commit.timestamp }}</div>
              </div>
              <p><small>Full HTML and log reports are available in GitHub Actions artifacts (download from workflow run).</small></p>
            </div>
            
            <h2>Download Full Reports</h2>
            <p>Full analysis reports are stored as compressed artifacts in GitHub Actions:</p>
            <ul>
              <li>Visit: <a href="https://github.com/${{ github.repository }}/actions">GitHub Actions</a></li>
              <li>Find the latest workflow run</li>
              <li>Download: <code>safec-analysis-log-XXXX</code> artifact (contains .html.gz and .log.gz files)</li>
              <li>Extract: <code>gunzip filename.gz</code></li>
            </ul>
            
            <hr>
            <p><small>Reports auto-generated by SafeC on each push to main branch. 
            <a href="https://github.com/${{ github.repository }}">View repository</a></small></p>
          </div>
        </body>
        </html>
        EOF

    - name: Prepare GitHub Pages content
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        # Create index.html and latest directory structure (not in gh-pages subfolder)
        mkdir -p latest
        
        # Create index.html at root
        cat > index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
          <title>SafeC Analysis Reports</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
            h1 { color: #333; }
            .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
            .report-link { margin: 10px 0; }
            .report-link a { color: #0366d6; text-decoration: none; font-size: 18px; }
            .report-link a:hover { text-decoration: underline; }
            .timestamp { color: #666; font-size: 14px; }
            .latest { background: #fff3cd; padding: 10px; border-radius: 4px; margin-bottom: 20px; }
          </style>
        </head>
        <body>
          <div class="container">
            <h1>üìä SafeC Analysis Reports</h1>
            <p>Latest vulnerability analysis reports from the SafeC static analyzer on the Juliet test suite.</p>
            
            <div class="latest">
              <strong>üìç Latest Report Summary:</strong>
              <div class="report-link">
                <a href="latest/report-summary.txt" target="_blank">üìÑ View Latest Summary</a>
              </div>
              <p><small>Full HTML and log reports are available in GitHub Actions artifacts (download from workflow run).</small></p>
            </div>
            
            <h2>Download Full Reports</h2>
            <p>Full analysis reports are stored as compressed artifacts in GitHub Actions:</p>
            <ul>
              <li>Visit: <a href="https://github.com/${{ github.repository }}/actions">GitHub Actions</a></li>
              <li>Find the latest workflow run</li>
              <li>Download: <code>safec-analysis-log-XXXX</code> artifact (contains .html.gz and .log.gz files)</li>
              <li>Extract: <code>gunzip filename.gz</code></li>
            </ul>
            
            <hr>
            <p><small>Reports auto-generated by SafeC on each push to main branch. 
            <a href="https://github.com/${{ github.repository }}">View repository</a></small></p>
          </div>
        </body>
        </html>
        EOF
        
        # Extract and get summary from analysis log
        if [ -f analysis.log ]; then
          tail -50 analysis.log > latest/report-summary.txt
          echo "" >> latest/report-summary.txt
          echo "=== Analysis Complete ===" >> latest/report-summary.txt
          echo "Full reports available in GitHub Actions artifacts." >> latest/report-summary.txt
          echo "Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> latest/report-summary.txt
        fi

    - name: Deploy to GitHub Pages via git
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add index.html latest/
        git commit -m "Deploy SafeC reports - run ${{ github.run_number }}" || true
        git push origin HEAD:gh-pages --force
    
    - name: Comment PR with Report Link
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'üìä SafeC Analysis Report\n\nDownload the detailed HTML report from the [workflow artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})'
          })
    
    - name: Check for Critical Vulnerabilities
      run: |
        echo "Analysis complete. Check the HTML report for detailed vulnerability findings."
