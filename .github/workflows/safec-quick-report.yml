name: SafeC Analysis - Quick Report

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  safec-analysis:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Checkout Juliet Test Suite
      run: |
        if [ ! -d "juliet-test-suite-c" ]; then
          git clone https://github.com/arichardson/juliet-test-suite-c.git
        fi
    
    - name: Cache build dependencies
      uses: actions/cache@v4
      with:
        path: build
        key: ${{ runner.os }}-safec-build-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-safec-build-
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake
    
    - name: Configure and build SafeC
      run: |
        mkdir -p build
        cd build
        cmake -DCMAKE_BUILD_TYPE=Release ..
        make -j$(nproc)
    
    - name: Run SafeC Static Analysis
      id: analysis
      run: |
        ./build/safec -d --html JulietPipelineReport.html ./juliet-test-suite-c/testcases 2>&1 | tee analysis.log
        # Exit codes: 0=no issues, 1=issues found, 2=critical issues found
        # All are considered successful analysis
        exit_code=$?
        if [ $exit_code -eq 0 ] || [ $exit_code -eq 1 ] || [ $exit_code -eq 2 ]; then
          exit 0
        fi
        exit $exit_code

    - name: Upload analysis log (always)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: safec-analysis-log-${{ github.run_id }}
        path: |
          analysis.log
          JulietPipelineReport.html
        retention-days: 90

    - name: Show tail of analysis log
      if: always()
      run: |
        if [ -f analysis.log ]; then
          echo "---- Last 200 lines of analysis.log ----";
          tail -n 200 analysis.log || true;
        else
          echo "No analysis.log found";
        fi
    
    - name: Generate analysis summary
      run: |
        echo "# SafeC Analysis Report" > analysis_summary.md
        echo "" >> analysis_summary.md
        echo "**Generated:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> analysis_summary.md
        echo "**Commit:** ${{ github.sha }}" >> analysis_summary.md
        echo "**Branch:** ${{ github.ref_name }}" >> analysis_summary.md
        echo "" >> analysis_summary.md
        echo "Analysis log:" >> analysis_summary.md
        echo "\`\`\`" >> analysis_summary.md
        tail -20 analysis.log >> analysis_summary.md
        echo "\`\`\`" >> analysis_summary.md
    
    - name: Upload analysis artifacts
      uses: actions/upload-artifact@v4
      with:
        name: safec-analysis-${{ github.run_id }}
        path: |
          JulietPipelineReport.html
          analysis_summary.md
          analysis.log
        retention-days: 90
    
    - name: Display analysis summary
      run: cat analysis_summary.md
    
    - name: Create GitHub Pages index
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        mkdir -p gh-pages
        cat > gh-pages/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
          <title>SafeC Analysis Reports</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
            h1 { color: #333; }
            .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
            .report-link { margin: 10px 0; }
            .report-link a { color: #0366d6; text-decoration: none; font-size: 18px; }
            .report-link a:hover { text-decoration: underline; }
            .timestamp { color: #666; font-size: 14px; }
            .latest { background: #fff3cd; padding: 10px; border-radius: 4px; margin-bottom: 20px; }
          </style>
        </head>
        <body>
          <div class="container">
            <h1>üìä SafeC Analysis Reports</h1>
            <p>Latest vulnerability analysis reports from the SafeC static analyzer on the Juliet test suite.</p>
            
            <div class="latest">
              <strong>üìç Latest Report:</strong>
              <div class="report-link">
                <a href="latest/JulietPipelineReport.html" target="_blank">View Latest SafeC Analysis Report</a>
                <div class="timestamp">Generated: ${{ github.event.head_commit.timestamp }}</div>
              </div>
            </div>
            
            <hr>
            <p><small>Reports auto-generated by SafeC on each push to main branch. 
            <a href="https://github.com/${{ github.repository }}">View repository</a></small></p>
          </div>
        </body>
        </html>
        EOF

    - name: Copy latest report
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        mkdir -p gh-pages/latest
        cp JulietPipelineReport.html gh-pages/latest/JulietPipelineReport.html
        cp analysis.log gh-pages/latest/analysis.log
    
    - name: Publish Report to GitHub Pages
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: gh-pages
        keep_files: true
        force_orphan: false
    
    - name: Post PR comment with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('analysis_summary.md', 'utf8');
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary + '\n\n[üìä View Full HTML Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})'
          })
